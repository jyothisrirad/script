#!/bin/bash

#=================================
help_hline3 'UHC'

#=================================
# $1: default to wait for key press for each score
#     <num> to sleep <num> sec between each score
mcscores() {
	# echo $1 $2
	while : ; do
		mcserver do scoreboard objectives setdisplay sidebar FinalKill
		if [ -z ${1+x} ]; then pause; else sleep $1; fi
		mcserver do scoreboard objectives setdisplay sidebar FinalEntity
		if [ -z ${1+x} ]; then pause; else sleep $1; fi
		mcserver do scoreboard objectives setdisplay sidebar FinalDiamond
		if [ -z ${1+x} ]; then pause; else sleep $1; fi
		mcserver do scoreboard objectives setdisplay sidebar FinalGold
		if [ -z ${1+x} ]; then pause; else sleep $1; fi
		mcserver do scoreboard objectives setdisplay sidebar FinalStone
		if [ -z ${1+x} ]; then pause; else sleep $1; fi
		mcserver do scoreboard objectives setdisplay sidebar FinalEat
		if [ -z ${1+x} ]; then pause; else sleep $1; fi
		mcserver do scoreboard objectives setdisplay sidebar List
		[[ $2 == 'forever' ]] || break
		if [ -z ${1+x} ]; then pause; else sleep $1; fi
	done
}


#=================================
# friendlyfireSet() {
	# for t in R Y G A B P E r y g a b p e
	# do 
		# mcserver do scoreboard teams option $t friendlyfire $1
	# done
# }


#=================================
team_all_set() {
	# for t in R Y G A B P E r y g a b p e 0 1
	for t in R Y G A B P E r y g a b p e
	do 
		mcserver do scoreboard teams option $t $1 $2
	done
}

#=================================
# aqua() { 
	# echo A 
# }

#=================================
uhclist() {
	# echo éšŠä¼IDåˆ—è¡¨
	# echo Solo=1
	# echo Spectate=0
	# echo Red=R
	# echo Yellow=Y
	# echo Green=G
	# echo Aqua=A
	# echo Blue=B
	# echo Light Purple=P
	# echo Gray=E
	# echo Dark Red=r
	# echo Gold=y
	# echo Dark Green=g
	# echo Dark Aqua=a
	# echo Dark Blue=b
	# echo Dark Purple=p
	# echo Dark Gray=e
	echo éšŠä¼ID:__[1]å–®äºº[0]æ—è§€è€…
	echo [R]ç´…éšŠ__[Y]é»ƒéšŠ[G]ç¶ éšŠ__[A]é’éšŠ__[B]è—éšŠ__[P]äº®ç´«éšŠ[E]ç°éšŠ
	echo [r]æ·±ç´…éšŠ[y]æ©˜éšŠ[g]æ·±ç¶ éšŠ[a]æ·±é’éšŠ[b]æ·±è—éšŠ[p]æ·±ç´«éšŠ[e]æ·±ç°éšŠ
}

#=================================
# playerlist() {
	# echo ç©å®¶ID:
	# mcdo list | grep.player
# }

#=================================
uhcstat() {
	LOG=/mnt/runtimes/$mcver/logs/list.log
	if [ -f "$LOG" ]; then 
		echo ä¸Šç·šåå–®:
		cat $LOG
	fi
	LOG=/mnt/runtimes/$mcver/logs/teams.log
	if [ -f "$LOG" ]; then 
		echo åƒè³½åå–®:
		cat $LOG
	fi
	LOG=/mnt/runtimes/$mcver/logs/slain.log
	if [ -f "$LOG" ]; then 
		echo æˆ°æ•—é †åº:
		cat $LOG
	fi
	LOG=/mnt/runtimes/$mcver/logs/winner.log
	if [ -f "$LOG" ]; then 
		echo æœ€å¾Œè´å®¶:
		cat $LOG
	fi
}

#=================================
uhcinit() {
	mcdo time set 0
	# mcdo tp @a 9475 65 3420
	mcdo op chsliu
	mcdo op creeper_arena
	mcdo gamemode 1 @a
	mcdo replaceitem entity @a slot.hotbar.7 command_block
	mcdo replaceitem entity @a slot.hotbar.8 redstone_block
}

#=================================
uhcteamcreate() {
	tmpscrpit=/tmp/teamcreate
	# echo . /home/sita/script/minecraft/alias.minecraft >$tmpscrpit
	# mcdo list | grep.player | team.select >>$tmpscrpit
	mcdo list | grep.player | /home/sita/script/minecraft/uhc.team.select >>$tmpscrpit
	cat $tmpscrpit
	mcdo gamerule sendCommandFeedback false
	. $tmpscrpit
	rm $tmpscrpit
}

#=================================
uhcteamchoice() {
	if [ ! -z ${1+x} ]; then 
		echo -e "${GREEN}åŠ å…¥éšŠä¼æ¬Šé™On${NC}"
		mcdo scoreboard players set @e[tag=F] J 0	#åŠ å…¥éšŠä¼æ¬Šé™Off
		mcdo scoreboard players set @e[tag=N] J 1	#åŠ å…¥éšŠä¼æ¬Šé™On
	else
		echo -e "${YELLOW}åŠ å…¥éšŠä¼æ¬Šé™Off${NC}"
		mcdo scoreboard players set @e[tag=F] J 1	#åŠ å…¥éšŠä¼æ¬Šé™Off
		mcdo scoreboard players set @e[tag=N] J 0	#åŠ å…¥éšŠä¼æ¬Šé™On
	fi
}

#=================================
otglist() {
	mcdo otg biome -f
	mcdo otg biome -s
	mcdo otg biome -d
	mcdo otg biome -m
}

#=================================
log_parse_teams() {
    [ ! -f "$1" ] && return
    logfile=$(pwd)/teams.log
    tmp=/tmp/teams.log
    cat $1 | egrep '\[*éšŠ\]' | awk '{ printf ("%s\n", $4) }' >$tmp
    file.replace.escape $tmp
    cat $tmp >$logfile
    
    cat $logfile
}

#=================================
log_parse_slain() {
    [ ! -f "$1" ] && return
    logfile=/tmp/slain.log
    logfile2=$(pwd)/slain.log
    cat $1 | grep.slain | grep -v DiscordSRV >$logfile
    file.cleanup $logfile
    file.replace.escape $logfile
    file.replace.teamtag $logfile
    cat $logfile >$logfile2
    echo >>$logfile2
    file.replace.cause $logfile
    file.replace.mob $logfile
    cat $logfile >>$logfile2
    
    cat $logfile2
}

#=================================
log_parse_winner() {
    [ ! -f "$1" ] && return
    logfile=$(pwd)/winner.log
    tmp=/tmp/winner.log
    cat $1 | grep '\[0;30;1' | egrep 'm([0-9]+,|=)' | awk '{ printf ("%s %s\n",$4,$5) }' >$tmp
    winner=$(cat $1 | grep æœ€å¾Œè´å®¶ | tail -n 1 | awk '{ printf ("%s\n", $4) }' | sed "s/æœ€å¾Œè´å®¶æ˜¯//g")
    echo ================================= >>$tmp
    echo æœ€å¾Œè´å®¶ $winner >>$tmp
    file.replace.escape $tmp
    cat $tmp >$logfile
    
    cat $logfile
}

#=================================
second_diff() {
# Convert the times to seconds from the Epoch
SEC1=`date +%s -d ${1}`
SEC2=`date +%s -d ${2}`

# Use expr to do the math, let's say TIME1 was the start and TIME2 was the finish
DIFFSEC=`expr ${SEC2} - ${SEC1}`

# echo Start ${1}
# echo Finish ${2}

# echo Took ${DIFFSEC} seconds.

# And use date to convert the seconds back to something more meaningful
# echo Took `date +%H:%M:%S -ud @${DIFFSEC}`

echo ${DIFFSEC}
}

log_parse_lag() {
    [ ! -f "$1" ] && return
    logfile=$(pwd)/lag.log
    tmpfile=$(pwd)/lag.tmp
    delayLimitms=5000
    rm $logfile
    cat $1 | grep.lag >$tmpfile
    totalms=$(cat $tmpfile | awk '{ printf ("%s\n", $18) }' | sed "s/ms//g" | sed '/^\s*$/d' | paste -sd+ - | bc)
    totaltick=$(cat $tmpfile | awk '{ printf ("%s\n", $21) }' | sed '/^\s*$/d' | paste -sd+ - | bc)
    TIME1=$(cat $1 | head -n 1 | awk '{ printf ("%s\n", $1) }' | sed "s/\[//g" | sed "s/\]//g")
    TIME2=$(cat $1 | tail -n 1 | awk '{ printf ("%s\n", $1) }' | sed "s/\[//g" | sed "s/\]//g")
    sec=$(second_diff $TIME1 $TIME2)
    per=$(echo "scale=2;100*$totalms/1000/$sec" | bc -l)
    max=$(cat $tmpfile | awk '{ printf ("%s\n", $18) }' | sed "s/ms//g" | sort -nr | head -n 1)
    # tops=$(cat $tmpfile | awk '{ printf ("%s\n", $18) }' | sed "s/ms//g" | sort -nr | head -n 20)
    tops=$(cat $tmpfile | awk '{ printf ("%s\n", $18) }' | sed "s/ms//g" | sort -nr | sed '/^\s*$/d' | sed 's/[^0-9]*//g' | awk '$1>'"$delayLimitms")
    count=$(cat $tmpfile | awk '{ printf ("%s\n", $18) }' | sed "s/ms//g" | sed '/^\s*$/d' | sort -nr | wc -l)
    avg=$(echo "scale=0;$totalms/$count" | bc -l)
    # echo ================================= >>$logfile
    echo Running total ${totalms}ms behind, skipping ${totaltick} tick\(s\), ${totalms}ms/${sec}sec=${per}%, with ${count} times, max delay is ${max}ms. avg delay is ${avg}ms. >>$logfile
    echo [$TIME1] to [$TIME2] for `date +%H:%M:%S -ud @${sec}` >$tmpfile
    gamestart=$(cat $1 | grep å‚³é€å€’æ•¸è¨ˆæ™‚ | awk '{ printf ("%s\n", $1) }' | sed "s/\[//g" | sed "s/\]//g")
    for top in $tops; do
        delaytimes=$(cat $1 | grep ${top}ms | awk '{ printf ("%s\n", $1) }' | sed "s/\[//g" | sed "s/\]//g")
        for delaytime in $delaytimes; do
            gametime=$(second_diff $gamestart $delaytime)
            echo [${delaytime}] `date +%H:%M:%S -ud @${gametime}` - Lag ${top}ms>>$tmpfile
        done
    done
    cat $1 | grep ç‰©å“ï¼ >>$tmpfile
    cat $tmpfile | sort >>$logfile
    
    cat $logfile
}

#=================================
log_parse_uhc() {
    log_parse_teams $*
    log_parse_slain $*
    log_parse_winner $*
    log_parse_lag $*
}

#=================================
alias mcsb='mcscores 3' #UHCæ’è¡Œæ¦œé–“éš”3ç§’
# alias mcsbs='mcscores $*'
alias mcwb='mcdo worldborder $*' #è¨­å®šä¸–ç•Œé‚Šç•Œ
alias mcwb0='mcdo worldborder set 60000000' #è¨­å®šä¸–ç•Œé‚Šç•Œ60000000
alias mcff='team_all_set friendlyfire true' #åŒéšŠå‚·å®³
alias mcfff='team_all_set friendlyfire false' #åŒéšŠå‚·å®³é—œé–‰

#=================================
help_hline2 'éšŠä¼'

help_add 'teamlist' 'åˆ—å‡ºéšŠä¼åç¨±'
help_add 'teamlist.<team>' 'åˆ—å‡ºéšŠä¼teamå…§ç©å®¶'
alias teamlist='mcdo scoreboard teams list'
help_add 'playerlist' 'åˆ—å‡ºç·šä¸Šç©å®¶åç¨±'
alias playerlist='echo ç©å®¶ID: && mcdo list | grep.player | sort'
help_add 'teamjoin.<team>.<id>' 'åŠ å…¥éšŠä¼'
alias teamjoin='teamlist && playerlist && mcdo scoreboard teams join $1 $2'

#=================================
help_hline1 'UHCåœ°åœ–è¨­å®š'
help_add 'ruleinit' 'UHCåˆå§‹'
alias ruleinit=uhcinit
help_add 'ruleset' 'UHCè¨­å®šè¦å‰‡'
alias ruleset='/home/sita/script/minecraft/uhc.rules $*'
help_add 'ruleotg' 'OTGåœ°åœ–'
alias ruleotg='otglist'
# alias uhcstart='/home/sita/script/minecraft/uhc.start'
# alias uhcend='/home/sita/script/minecraft/uhc.end'

#=================================
help_hline1 'UHCéŠæˆ²ä¸­'
help_add 'uhclist' 'UHCåˆ—å‡ºteamåç¨±'
alias uhcstat=uhcstat
alias uhcselect='/home/sita/script/minecraft/uhc.team.select $*'
help_add 'uhccreate' 'UHCéš¨æ©Ÿåˆ†éšŠ'
alias uhccreate=uhcteamcreate
help_add 'uhcjoin.<team>.<id>' 'UHCåŠ å…¥éšŠä¼'
alias uhcjoin='uhclist && playerlist && mcdo scoreboard teams join $1 $2'
help_add 'uhcsolo.<id>' 'UHCåŠ å…¥å–®äººéšŠä¼'
alias uhcsolo='mcserver do scoreboard teams join 1 @a'
help_add 'uhcchoice' 'UHCé–‹å•ŸåŠ å…¥éšŠä¼æ¬Šé™'
alias uhcchoice='uhcteamchoice $*'

help_hline1 'UHCæ§åˆ¶'

help_add 'uhctime.<minutes>' 'UHCè¨­å®šæ™‚é–“'
alias uhctime='mcdo scoreboard players set @e[tag=N] minute $*'
help_add 'uhcshrink' 'UHCé–‹å§‹ç¸®åœ°åœ–'
alias uhcshrink='mcdo scoreboard players set @e[tag=N] b 0'
# help_add 'uhcfinal' 'UHCæœ€å¾Œæ±ºæˆ°'
# alias uhcfinal='mcdo scoreboard players set @e[tag=N] FinalTime 0'
help_add 'uhcfinal.<ticks>' 'UHCæœ€å¾Œæˆ°å ´å€’æ•¸'
alias uhctime='mcdo scoreboard players set @e[tag=N] FinalWar $*'

#=================================
help_hline1 'UHCç´€éŒ„åˆ†æ'
help_add 'logteams.<log>' 'UHCåˆ†æåƒè³½åå–®'
alias logteams='log_parse_teams $*'
help_add 'logslain.<log>' 'UHCåˆ†ææ®ºäººç´€éŒ„'
alias logslain='log_parse_slain $*'
help_add 'logwinner.<log>' 'UHCåˆ†æè´å®¶'
alias logwinner='log_parse_winner $*'
help_add 'loglag.<log>' 'UHCåˆ†æå»¶é²'
alias loglag='log_parse_lag $*'
help_add 'loguhc.<log>' 'UHCè³½å¾Œåˆ†æ'
alias loguhc='log_parse_uhc $*'
