#!/bin/bash

#=================================
help_hline3 'æ¬Šé™(pex)'

#=================================
idlist=~/idlist

#=================================
group_list() {
    [ -f $idlist ] && rm $idlist
    
    while test ${#} -gt 0
    do
        echo -e "${GREEN}=== $mcver pex group $1 users ${NC}"
        export LOG_DELAY=.3
        mcserver do pex group $1 users | tail -n +4 | awk 'BEGIN {FS="/"}; {printf("%s\n", $3)}' | sed 's/\[m//g' >>$idlist
        export LOG_DELAY=.1
        shift
    done
    
    [ -f $idlist ] && cat $idlist
}

group_add() {
    [ -z "$2" ] && echo need groupname and idlist && return
    idfile=$idlist
    [ ! -z "$2" ] && [ -f "$2" ] && idfile=$2
    [ -f $idfile ] && ids=`cat $idfile`
    for id in $ids
    do
        mcserver do pex group $1 user add $id
    done
}

group_clear() {
    [ -z "$2" ] && echo need groupname and idlist && return
    idfile=$idlist
    [ ! -z "$2" ] && [ -f "$2" ] && idfile=$2
    [ -f $idfile ] && ids=`cat $idfile`
    for id in $ids
    do
        mcserver do pex group $1 user remove $id
    done
}

group_set() {
    [ -z "$1" ] && echo need groupname && return
    [ ! -f ~/$1 ] && echo need preset list ~/$1 && return
    group_list $1
    group_clear $1 $idlist
    group_add $1 ~/$1
}

#=================================
op_list() {
    echo -e "${GREEN}=== $mcver op list ${NC}"
    cat /mnt/runtimes/$mcver/ops.json | grep name | awk 'BEGIN {FS="\""}; {printf("%s\n", $4)}' | sed 's/\[m//g' >$idlist
    cat $idlist
}

op_add() {
    idfile=$idlist
    [ ! -z "$1" ] && [ -f "$1" ] && idfile=$1
    [ -f $idfile ] && ids=`cat $idfile`
    for id in $ids
    do
        mcserver do op $id
    done
}

op_clear() {
    op_list
    
    idfile=$idlist
    [ ! -z "$1" ] && [ -f "$1" ] && idfile=$1
    [ -f $idfile ] && ids=`cat $idfile`
    for id in $ids
    do
        mcserver do deop $id
    done
}

#=================================
whitelist_list() {
    [ -f $idlist ] && rm $idlist
    echo -e "${GREEN}=== $mcver whitelist list ${NC}"
    
    # ids=$(mcserver do whitelist list | tail -n +4 | awk '{$1=$2=$3=""; print $0;}' | sed 's/and/ /g' | sed 's/,/ /g')
    # for id in $ids
    # do
        # echo $id >>$idlist
    # done
    
    cat /mnt/runtimes/$mcver/whitelist.json | grep name | awk 'BEGIN {FS="\""}; {printf("%s\n", $4)}' | sed 's/\[m//g' >$idlist
    [ -f $idlist ] && cat $idlist
}

whitelist_add() {
    idfile=$idlist
    [ ! -z "$1" ] && [ -f "$1" ] && idfile=$1
    [ -f $idfile ] && ids=`cat $idfile`
    for id in $ids
    do
        mcserver do whitelist add $id
    done
}

whitelist_clear() {
    idfile=$idlist
    [ ! -z "$1" ] && [ -f "$1" ] && idfile=$1
    [ -f $idfile ] && ids=`cat $idfile`
    for id in $ids
    do
        mcserver do whitelist remove $id
    done
}

#=================================
help_add 'mcw.<on|off>' 'ç™½æ¸…å–®On/Off'
alias mcw='mcdo whitelist $*'
alias mcwa='mcdo whitelist add $*'
alias mcwo='mcdo whitelist on'
alias mcwf='mcdo whitelist off'

#=================================
help_add 'wl' 'ç™½æ¸…å–®åˆ—å‡º'
alias wl='whitelist_list'
help_add 'wladd.<lst>' 'ç™½æ¸…å–®æ–°å¢'
alias wladd='whitelist_add $*'
help_add 'wlclear.<lst>' 'ç™½æ¸…å–®ç§»é™¤'
alias wlclear='whitelist_clear $*'

#=================================
help_add 'oplist' 'opåˆ—å‡º'
alias oplist='op_list'
help_add 'opadd.<lst>' 'opæ–°å¢'
alias opadd='op_add $*'
help_add 'opclear.<lst>' 'opç§»é™¤'
alias opclear='op_clear $*'

#=================================
help_add 'pexlist.<grp>' 'æ¬Šé™ç¾¤çµ„åˆ—å‡ºæˆå“¡'
alias pexlist='group_list $*'
alias grouplistall='group_list vip youtuber admin owner'
alias groupadd='group_add $*'
alias groupremove='group_clear $*'
help_add 'pexset.<grp>.<lst>' 'æ¬Šé™ç¾¤çµ„è¨­å®šæˆå“¡æ¸…å–®'
alias pexset='group_set $*'
